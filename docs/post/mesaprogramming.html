<!doctype html><html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>rybl.net | Mesaprogramming</title><link rel="stylesheet" href="/asset/style/common.css"/><link rel="stylesheet" href="/asset/style/util.css"/><link rel="stylesheet" href="/asset/style/Top.css"/><link rel="stylesheet" href="/asset/style/Tag.css"/><link rel="stylesheet" href="/asset/style/ParsedDate.css"/><link rel="stylesheet" href="/asset/style/Header.css"/><link rel="stylesheet" href="/asset/style/Footer.css"/><link rel="stylesheet" href="/asset/style/Raindrops.css"/><link rel="stylesheet" href="/asset/style/Markdown.css"/><script src="/asset/script/Top.js"></script><script src="/asset/script/parallax_on_scroll.js"></script><link rel="stylesheet" href="/asset/style/Post.css"/><link rel="stylesheet" href="/asset/style/PostNameCard.css"/><script src="/asset/script/Post.js"></script></head><body><svg style="width:0;height:0;position:absolute;"><filter id="nightsky"><feTurbulence id="nightsky-turbulence" type="fractalNoise" baseFrequency="0.1" numOctaves="1" stitchTiles="stitch" result="noise"></feTurbulence><feTile in="noise" result="tiled_noise"></feTile><feOffset id="nightsky-turbulenceOffset" in="tiled_noise" dx="0" dy="0" result="offset_noise"></feOffset><feComponentTransfer in="offset_noise" result="stars_pattern"><feFuncA type="discrete" tableValues="0 0 0 1"></feFuncA></feComponentTransfer><feColorMatrix in="stars_pattern" type="matrix" values="1 0 0 0 0
                          0 1 0 0 0
                          0 0 1 0 0
                          0.333 0.333 0.333 0 0"></feColorMatrix></filter><filter id="warp"><feTurbulence id="turbulence-generator" type="fractalNoise" baseFrequency="0.01 0.04" numOctaves="1" seed="2" result="turbulence"></feTurbulence><feDisplacementMap in="SourceGraphic" in2="turbulence" scale="100" xChannelSelector="R" yChannelSelector="G" result="displacement"></feDisplacementMap></filter><filter id="gooey"><feGaussianBlur in="SourceGraphic" stdDeviation="15" result="blur"></feGaussianBlur><feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo"></feColorMatrix><feBlend in="SourceGraphic" in2="goo"></feBlend></filter></svg><div id="background"></div><header><div class="logo"><img src="/asset/image/profile.png"/></div><div class="name"><div class="website_name"><a href="/">rybl.net</a></div><div class="separator"></div><div class="resource_shortname"><div>u/bxGWaHtsEzG9no+nKnwoDD5IfIIUGgvn1wpTvWzU9VAgwtoP2az+i3QDoTJY+SpXyy130/ZpDQdhkApau1AQ==</div></div></div><div class="menu"><a href="/index.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon lucide lucide-library-icon lucide-library"><path d="m16 6 4 14"></path><path d="M12 6v14"></path><path d="M8 8v12"></path><path d="M4 4v16"></path></svg></a><a href="/Tags.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon lucide lucide-tag-icon lucide-tag"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"></path><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"></circle></svg></a><a href="/About.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon lucide lucide-info-icon lucide-info"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg></a><a href="/Profiles.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe-icon lucide-globe"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path><path d="M2 12h20"></path></svg></a><a href="/ReferencesGraphPage.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-orbit-icon lucide-orbit"><path d="M20.341 6.484A10 10 0 0 1 10.266 21.85"></path><path d="M3.659 17.516A10 10 0 0 1 13.74 2.152"></path><circle cx="12" cy="12" r="3"></circle><circle cx="19" cy="5" r="2"></circle><circle cx="5" cy="19" r="2"></circle></svg></a><a href="/Signature.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-fingerprint-icon lucide-fingerprint"><path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4"></path><path d="M14 13.12c0 2.38 0 6.38-1 8.88"></path><path d="M17.29 21.02c.12-.6.43-2.3.5-3.02"></path><path d="M2 12a10 10 0 0 1 18-6"></path><path d="M2 16h.01"></path><path d="M21.8 16c.2-2 .131-5.354 0-6"></path><path d="M5 19.5C5.5 18 6 15 6 12a6 6 0 0 1 .34-2"></path><path d="M8.65 22c.21-.66.45-1.32.57-2"></path><path d="M9 6.8a6 6 0 0 1 9 5.2v2"></path></svg></a></div></header><main><div class="content"><div class="PostNameCard without_nameImage"><h1 class="layer2"><a href="/post/mesaprogramming.html">Mesaprogramming</a></h1></div><ol class="tableOfContents">
<li><a href="#Dependent%20Types" title="Dependent Types">Dependent Types</a></li>
<li><a href="#Metaprogramming" title="Metaprogramming">Metaprogramming</a></li>
<li><a href="#Embedded%20Languages" title="Embedded Languages">Embedded Languages</a></li>
<li><a href="#Mesaprogramming" title="Mesaprogramming">Mesaprogramming</a></li>
<li><a href="#References" title="References">References</a></li>
</ol>
<p>Whenever I write "language" I implicitly mean "programming langauge".</p>
<div class="headingWrapper"><h2 id="Dependent%20Types"><a href="http://localhost:3000/post/mesaprogramming.html#Dependent%20Types">Dependent Types</a></h2></div>
<div class="headingWrapper"><h2 id="Metaprogramming"><a href="http://localhost:3000/post/mesaprogramming.html#Metaprogramming">Metaprogramming</a></h2></div>
<p><em>Metaprogramming</em> is the design of programs that generate code meant to be used
at the same of a similarly high level of abstraction as the metaprogram's
language. For example, the popular languages Python and Javascript each provide
a built-in function called <code>eval</code> that takes as input a string and then tries to
<em>interpret</em> that string as a piece of code in the respective language (here,
"interpret" refers to immediately executing the code a high level rather than
first <em>compiling</em> that code to a low-level representation, usually C or
Assembly).</p>
<p>Metaprogramming is the ultimate abstraction, since (almost) any pattern of code
at all can be generated by a metaprogram of the same or smaller size
(asymptotically, at the very least). However, metaprogramming can also yield
some severe side-effects.</p>
<ol>
<li>Generated code is not directly visible while programming, so there is an
additional layer of obfuscation between programming and feedback.</li>
<li>Metaprograms usually only have limited access to static information, which
inferred by the compiler, about the programs to be generated. On top of this,
metaprograms are not usually checked to make sure they generate valid
programs. Python and Javascript's <code>eval</code> function know that their argument is
a string and nothing more!</li>
</ol>
<p>For example, Template Haskell provides a monad <code>Q :: * -> *</code> which is the type
of computations that produce Haskell code. Here is a metaprogram that, at
compile-time, generates a function that sums <code>n</code> arguments. Without
metaprogramming, there is no basic functionality for variable-arity functions in
Haskell.</p>
<pre><code class="language-haskell">addN :: Int -> Q Exp
addN n = do
  xs &#x3C;- replicateM n (newName "x")
  lamE (varP &#x3C;$> xs) (foldM (\e v -> [| $e + $v |]) [| 0 |] xs)

n :: Int
n = $(addN 2) 1 2
-- n == 1 + 2
-- n == 3
</code></pre>
<div class="headingWrapper"><h2 id="Embedded%20Languages"><a href="http://localhost:3000/post/mesaprogramming.html#Embedded%20Languages">Embedded Languages</a></h2></div>
<p>The definition of a language consists of its syntax and semantics. The
<strong>syntax</strong> of a language is the specification for well-formed programs in the
language. The <strong>semantics</strong> of a language is a mapping from it's syntax to
computational behaviors.</p>
<p>Usually, the semantics of a language are represented as a function from the
syntax of a higher-level language to the syntax of a lower-level langauge. For
example, a compiled language (e.g. C++, Haskell) has a corresponding compiler
which encodes semantics with a function, <code>compile</code>, from the language syntax to
assembly code. Then the assembly code is compiled into executable bytecode. And
finally hte executable bytecode is "compiled" into basic computational
operations. Beyond this is an descent into the physical implementation of the
computer, and further into the physical processes that make up the physical
execution.</p>
<p>Metaprogramming slighly confuses this setup, however. A metaprogram is a program
that can actually refer to the syntax of itself by representing the program as a
string, and it can refer to the semantics of itself by calling the <code>eval</code>
function. So, the hierarchy described in the previous section can have cycles.</p>
<p>Even without metaprogramming though, we can interface directly with this
hierarchy via an embedded language. An <strong>embedded language</strong> is a language where
its syntax and semantics are defined entirely within a higher-level language. A
compiled language is almost like an embedded language within its compiler's
language, but it is not because the compiler's language is not a (usually) a
lower-level language than the compiled language. So, embedded languages are sort
of like reverse compiled languages.</p>
<p>As a very simple example, here is a way of embedding the untyped lambda calculus
within Haskell:</p>
<pre><code class="language-haskell">data Term = Var String | Lam String Term | App Term Term
  deriving (Show)

type Ctx = String -> Maybe Term

eval :: Ctx -> Term -> Maybe Term
eval ctx (Var x) = ctx x
eval ctx (Lam x b) = Just (Lam x b)
eval ctx (App (Lam x b) a) = eval (\y -> if x == y then b else ctx y) b
eval ctx (App _ _) = Nothing

example1 :: Maybe Term
example1 = eval (\_ -> Nothing) (App (Lam "x" (Var "x")) (Var "y"))
-- example1 = eval ((λ x . x) y)
-- example1 == Just (Var "y")

example2 :: Maybe Term
example2 = eval (\_ -> Nothing) (App (Var "x") (Var "y"))
-- example2 = eval (x y)
-- example2 == Nothing

example3 :: Maybe Term
example3 = eval (\_ -> Nothing) (App (Lam "x" (Var "y")) (Var "z"))
-- example3 = eval ((λ x . y) z)
-- example3 == Nothing

</code></pre>
<p>The datatype <code>Term</code> defined the syntax of the language, and the function <code>eval</code>
defined the syntax of the language. Note that, since <code>eval</code> returns a
<code>Maybe Term</code>, it can be considered partial on the entire syntax domain. That is,
some syntactically-valid programs are not meaningful i.e. they don't have
semantics. For example, <code>example2</code> tries to apply a non-lambda, and <code>example3</code>
refers to an unbound variable.</p>
<p>So, what's the point of embedded languages? Two interesting use cases are the
following:</p>
<ol>
<li>A language (or, at least, parts of it) can be embedded within itself to
facilitate metaprogramming capabilities. Rather than just attempt to parse
unstrucutred strings like JavaScript and Python's <code>eval</code>, languages like
Haskell (via <a href="https://wiki.haskell.org/Template_Haskell" class="LinkWithIcon"><img src="/asset/icon/wiki_haskell_org" class="icon"><span class="label">Template Haskell</span></a>)
and C++ (via
<a href="https://docs.microsoft.com/en-us/cpp/cpp/templates-cpp" class="LinkWithIcon"><img src="/asset/icon/docs_microsoft_com" class="icon"><span class="label">templates</span></a>) offer a
metaprogramming interface for manipulate structured representations of the
language's syntax. This makes writing and reasoning about metaprograms
somewhat easier.</li>
<li>A language of interest can be embedded within a proof assistant language,
such as Agda or Coq, in order for the programmer to write proofs about the
syntax and semantics of programs in the embedded language. This is useful for
verifying properties of important programs in the embedded language, such as
<a href="https://compcert.org" class="LinkWithIcon"><img src="/asset/icon/compcert_org" class="icon"><span class="label">compilers</span></a>.</li>
</ol>
<p>In the following section, I will introduce another use case, mesaprogramming,
which is a combination of these two use cases.</p>
<div class="headingWrapper"><h2 id="Mesaprogramming"><a href="http://localhost:3000/post/mesaprogramming.html#Mesaprogramming">Mesaprogramming</a></h2></div>
<p>The usual technique of metaprogramming ("above-programming") is to provide a
special interface for invoking code generation (e.g. templates as a built-in or
library feature). The main issue with this is that it requires a new
metaprogramming language to be built on top of the base language, which comes
with complicated language features and usually little to none of the safety
features of the original language. This is a serious issue because writing
correct metaprograms is very difficult, especially when their output is not
easily accessible.</p>
<p><strong>Mesaprogramming</strong> ("below-programming") is an alternative technique that can
be implemented in any language, and is most powerful in proof assistant
languages. Rather than write a metaprogramming language <em>on top</em> of the base
language, the technique of mesaprogramming is to define an embedded
mesaprogramming language <em>inside of</em> the base language as a formalization of a
fragment of the base language (defining the entire language within itself comes
with many issues: TODO).</p>
<p>For example, variable arity functions in Haskell:</p>
<pre><code class="language-haskell">{-# LANGUAGE DataKinds #-}
{-# LANGUAGE GADTs #-}
{-# LANGUAGE KindSignatures #-}
{-# LANGUAGE RankNTypes #-}
{-# LANGUAGE TypeFamilies #-}

data Nat = Zero | Suc Nat

data SNat :: Nat -> * where
  SZero :: SNat Zero
  SSuc :: SNat n -> SNat (Suc n)

n0 :: SNat Zero
n0 = SZero

n1 :: SNat (Suc Zero)
n1 = SSuc SZero

n2 :: SNat (Suc (Suc Zero))
n2 = SSuc (SSuc SZero)

n3 :: SNat (Suc (Suc (Suc Zero)))
n3 = SSuc (SSuc (SSuc SZero))

type family EndoN (a :: *) (n :: Nat) :: * where
  EndoN a Zero = a
  EndoN a (Suc n) = a -> EndoN a n

-- given a (singleton for) natural number `n`, is an `n`-ary function that adds its inputs
addN :: SNat n -> EndoN Int n
addN SZero = 0
addN (SSuc SZero) = \x -> x
addN (SSuc (SSuc n)) = \x y -> addN (SSuc n) (x + y)
</code></pre>
<p>For example, TODO: example of metaprogramming in python</p>
<pre><code class="language-python"></code></pre>
<div class="headingWrapper"><h2 id="References"><a href="http://localhost:3000/post/mesaprogramming.html#References">References</a></h2></div>
<ul>
<li><a href="https://wiki.haskell.org/Template_Haskell" class="LinkWithIcon"><img src="/asset/icon/wiki_haskell_org" class="icon"><span class="label">Template Haskell - HaskellWiki</span></a></li>
<li><a href="https://docs.microsoft.com/en-us/cpp/cpp/templates-cpp" class="LinkWithIcon"><img src="/asset/icon/docs_microsoft_com" class="icon"><span class="label">Templates (C++)</span></a></li>
<li><a href="https://compcert.org/" class="LinkWithIcon"><img src="/asset/icon/compcert_org" class="icon"><span class="label">CompCert - Main page</span></a></li>
</ul></div></main><header><div class="menu"><a href="/index.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon lucide lucide-library-icon lucide-library"><path d="m16 6 4 14"></path><path d="M12 6v14"></path><path d="M8 8v12"></path><path d="M4 4v16"></path></svg></a><a href="/Tags.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon lucide lucide-tag-icon lucide-tag"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"></path><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"></circle></svg></a><a href="/About.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon lucide lucide-info-icon lucide-info"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg></a><a href="/Profiles.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe-icon lucide-globe"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path><path d="M2 12h20"></path></svg></a><a href="/ReferencesGraphPage.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-orbit-icon lucide-orbit"><path d="M20.341 6.484A10 10 0 0 1 10.266 21.85"></path><path d="M3.659 17.516A10 10 0 0 1 13.74 2.152"></path><circle cx="12" cy="12" r="3"></circle><circle cx="19" cy="5" r="2"></circle><circle cx="5" cy="19" r="2"></circle></svg></a><a href="/Signature.html" class="item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-fingerprint-icon lucide-fingerprint"><path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4"></path><path d="M14 13.12c0 2.38 0 6.38-1 8.88"></path><path d="M17.29 21.02c.12-.6.43-2.3.5-3.02"></path><path d="M2 12a10 10 0 0 1 18-6"></path><path d="M2 16h.01"></path><path d="M21.8 16c.2-2 .131-5.354 0-6"></path><path d="M5 19.5C5.5 18 6 15 6 12a6 6 0 0 1 .34-2"></path><path d="M8.65 22c.21-.66.45-1.32.57-2"></path><path d="M9 6.8a6 6 0 0 1 9 5.2v2"></path></svg></a></div><div class="name"><div class="website_name"><a href="/">rybl.net</a></div><div class="separator"></div><div class="resource_shortname"><div>u/bxGWaHtsEzG9no+nKnwoDD5IfIIUGgvn1wpTvWzU9VAgwtoP2az+i3QDoTJY+SpXyy130/ZpDQdhkApau1AQ==</div></div></div><div class="logo"><img src="/asset/image/profile.png"/></div></header></body></html>